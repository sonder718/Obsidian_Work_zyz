# 什么是ICMP协议
- 为了提高IP数据报交付成功的机会,在网络层使用了网际控制报文协议(Internet ControlMessage Protocol, ICMP)来让**主机或路由器**==报告差错和异常情况==。 #注意
- ICMP是==IP层==协议。 #注意
	- ICMP报文作为**IP层数据报的数据**,加上数据报的首部,组成IP数据报发送出去。

# ICMP协议的应用
- 分组网间探测 PING(用来测试两台主机之间的连通性)
	- 其中 PING 使用了==ICMP 回送请求==和==回答报文== #注意 
		- 不是差错响应报文
	- PING 工作在==应用层==,它**直接使用网络层的 ICMP**,而未使用传输层的 TCP 或 UDP. #注意
- Traceroute(UNIX 中的名字,在 Windows 中是 Tracert,可以用来跟踪==分组经过的路由==)。 
	- Traceroute(Tracert)使用了 ==ICMP 时间超过报文==。
	- Traceroute/Tracert 工作在==网络层==。


# ICMP报文
- ICMP报文的种类有两种,即**ICMP差错报告报文**和**ICMP询问报文**。
## ICMP差错报告报文
- ICMP差错报告报文用于目标主机或到目标主机路径上的**路由器**向==源主机==报告差错和异常情况。
- 共有以下5种类型:
	- 1)**终点不可达**。
		- 当路由器或主机不能交付数据报时,就向源点发送终点不可达报文。
	- 2)**源点抑制**。
		- 当路由器或主机由于==拥塞==而丢弃数据报时,就向源点发送源点抑制报文,使源点知道应当把数据报的发送速率放慢。 #注意
	- 3)**时间超过**。
		- 当路由器收到**生存时间(TTL)为零**的数据报时,除丢弃该数据报外,还要向源点发送时间超过报文。
		- 当终点在预先规定的时间内**不能收到一个数据报的全部数据报片**时,就把已收到的数据报片都丢弃,并向源点发送时间超过报文。
	- 4)**参数问题**。
		- 当路由器或目的主机收到的数据报的首部中有的字段的值不正确时,就丢弃该数据报,并向源点发送参数问题报文。
			- 🐱 分组长度超过 MTU,且DF=1时,丢弃该分组,并报告
	- 5)**改变路由**(重定向)。
		- 路由器把改变路由报文发送给主机,让主机知道下次应将数据报发送给另外的路由器(**可通过更好的路由**)。
- **何时不发送ICMP报文**
	- 1)对 **ICMP 差错报告报文**不再发送ICMP 差错报告报文。
		- 🐱即本身出错不再发送
	- 2)对**第一个分片**的数据报片的所有后续数据报片都不发送 ICMP 差错报告报文。
	- 3)对具有**组播地址**的数据报都不发送 ICMP 差错报告报文。
	- 4)对具有特殊地址(如 127.0.0.0 或 0.0.0.0)的数据报不发送ICMP 差错报告报文。
## ICMP询问报文
- ICMP 询问报文有4种类型:
	- **回送请求和回答报文**
	- **时间戳请求和回答报文**
	- 地址掩码请求和回答报文
	- 路由器询问和通告报文,最常用的是前两类。

##### Tips
- #注意 12B应用层数据,TCB的最大传输效率是12/(20+12),==只需考虑TCB首部==
##### TCP报文段的组成
- **首部** (最大长度60B)
	- **固定**:==20B== #注意
	- 选项:4N B
- **数据**
- ![](attachments/TCP%E6%8A%A5%E6%96%87%E6%AE%B5%202022-11-08%2023.58.57.excalidraw.svg)
%%[🖋 Edit in Excalidraw](attachments/TCP%E6%8A%A5%E6%96%87%E6%AE%B5%202022-11-08%2023.58.57.excalidraw.md), and the [dark exported image](attachments/TCP%E6%8A%A5%E6%96%87%E6%AE%B5%202022-11-08%2023.58.57.excalidraw.dark.svg)%%
##### TCP字段的具体解析
###### 源端口和目的端口字段
-   TCP源端口（Source Port）：源计算机上的应用程序的端口号，占 16 位。
-   TCP目的端口（Destination Port）：目标计算机的应用程序端口号，占 16 位。
###### 序列号字段
- TCP序列号（Sequence Number）：占 32 位。
	- 它表示本报文段所发送数据的**第一个字节的编号**。
	- 在 TCP 连接中，所传送的==字节流==的每一个字节都会**按顺序编号**。
		- 序号建立在传送的字节流之上,而不建立在报文段之上。
	- 当SYN标记不为1时，这是当前数据分段**第一个字母**的序列号；
		- 🐱针对**发送方**:报文段SN=301,携带100B**数据**,要==发送==的下一个报文SN=401
		- ![](attachments/Pasted%20image%2020221110231009.png)
	- 如果SYN的值是1时，这个字段的值就是初始序列值（ISN），用于对序列号进行同步。这时，第一个字节的序列号比这个字段的值大1，也就是ISN加1。
###### 确认号字段
- TCP 确认号（Acknowledgment Number，ACK Number）：占 32 位。
- 它表示接收方**期望**收到发送方下一个报文段的第一个字节数据的编号。 #注意
- 其值是接收计算机**即将接收到的下一个序列号**，也就是下一个接收到的字节的序列号加1。
	- 🐱针对**接收方**:==收到==报文段SN=301,携带100B**数据**,确认报文中ACKnumber=410
###### 数据偏移字段
- TCP 首部长度（Header Length）：
	- 数据偏移是指数据段中的“数据”部分起始处距离 TCP 数据段起始处的字节偏移量，占 4 位。
		- 以==4B==为**单位**
	- 其实这里的“数据偏移”也是在确定 TCP 数据段**头部分的长度**，告诉接收端的应用程序，数据从何处开始。
		-  4 位最大表示15,因此TCP 首部最大长度60B
###### 保留字段
- 保留（Reserved）：占 4 位。为 TCP 将来的发展预留空间，目前必须全部**为 0**。
###### 标志位字段
-   CWR（Congestion Window Reduce）：拥塞窗口减少标志，用来表明它接收到了设置 ECE 标志的 TCP 包。
	- 并且，发送方收到消息之后，通过减小发送窗口的大小来降低发送速率。
-   ECE（ECN Echo）：用来在 TCP 三次握手时表明一个 TCP 端是具备 ECN 功能的。
	- 在数据传输过程中，它也用来表明接收到的 TCP 包的 IP 头部的 ECN 被设置为 11，即网络线路拥堵。
-   URG（Urgent）：表示本报文段中发送的数据是否包含紧急数据。
	- URG=1 时表示有紧急数据。当 URG=1 时，后面的紧急指针字段才有效。
-   ACK：表示前面的确认号字段是否有效。
	- ACK=1 时表示有效。
	- 只有当 ACK=1 时，前面的确认号字段才有效。TCP 规定，连接建立后，ACK 必须为 1。
-   PSH（Push）：告诉对方收到该报文段后是否立即把数据推送给上层。
	- 如果值为 1，表示应当立即把数据提交给上层，而不是缓存起来。
-   RST：表示是否重置连接。
	- 如果 RST=1，说明 TCP 连接出现了严重错误（如主机崩溃），必须释放连接，然后再重新建立连接。
-   SYN：在建立连接时使用，用来同步序号。
	- 当 SYN=1，ACK=0 时，表示这是一个**请求建立连接**的报文段；
	- 当 SYN=1，ACK=1 时，表示对方**同意建立连接**。
	- SYN=1 时，说明这是一个请求建立连接或同意建立连接的报文。只有在前两次握手中 SYN 才为 1。
-   FIN：标记数据是否发送完毕。如果 FIN=1，**表示数据已经发送完成，可以释放连接**。 ^xi21ce
###### 窗口大小字段
- 窗口大小（Window Size）：占 16 位。它表示从 Ack Number 开始**还可以接收多少字节的数据量**，也表示==当前接收端的接收窗口==还有多少剩余空间。
- 该字段可以用于 TCP 的流量控制。
###### TCP 校验和字段
- 校验位（TCP Checksum）：占 16 位。它用于确认传输的数据是否有损坏。发送端基于数据内容校验生成一个数值，接收端根据接收的数据校验生成一个值。两个值必须相同，才能证明数据是有效的。如果两个值不同，则丢掉这个数据包。
- Checksum 是根据**伪头 + TCP 头 + TCP 数据**三部分进行计算的。
###### 紧急指针字段
- 紧急指针（Urgent Pointer）：仅当前面的 URG 控制位为 1 时才有意义。它指出本数据段中为紧急数据的字节数，占 16 位。
- 当所有紧急数据处理完后，TCP 就会告诉应用程序恢复到正常操作。即使当前窗口大小为 0，也是可以发送紧急数据的，因为紧急数据无须缓存。
###### 可选项字段
- 选项（Option）：长度不定，但长度必须是 32bits 的整数倍。
	- ![](attachments/Pasted%20image%2020221111200834.png)
- 第一个kind= 2，表示**最大报文段长度**（Max Segment Size，MSS）
	- MSS应尽量大一些,只要在IP层传输时不要再分片就行
	- MSS是TCP报文段中的==数据字段==的最大长度 #注意
	- TCP模块通常将MSS设置为（MTU-==40==）字节（**减掉的这40字节包括20字节的TCP头部和20字节的IP头部**）。 #注意
		- 🐱以太网的MTU为1500B，而许多广域网的MTU不超过576B。
		- [[IP数据报分片-链路层MTU的限制]]
	- MSS的默认值是576-40=536B
		- [[Nagle算法]]
	- 对以太网而言，MSS值是1460（1500-40）字节。
	- ![](attachments/Pasted%20image%2020221111201417.png)
-  kind = 8，代表Timestamps，即**时间戳**，启用Timestamp Option后，每个TCP Segment中都会带有Timestamp Option，其中包含了两个**32bit的Timestamp也就是各四个字节的Timestamp Value（TSval）和Timestamp Echo Reply（TSecr）**。发送方在发送报文段时把当前时钟的时间值放入时间戳字段，接收方在确认该报文段时把时间戳字段值复制到时间戳回送回答字段。因此，发送方在收到确认报文后，可以准确计算出RTT。
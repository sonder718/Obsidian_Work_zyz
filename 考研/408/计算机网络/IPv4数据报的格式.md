# IPV4分组
## IPv4分组与IP数据报
- 网络层将**传输层**的数据打包后，如果数据很小，可以称为==IP数据报==
- 如果数据过大则进行==分片==，每一片称为==IPv4分组==。一般数据都比较多，大部分情况都是分组。 #注意 
	- 因此总长度字段**会变化**
## IPv4分组的格式
### 总体格式
- 一个IP分组由**首部**和**数据**两部分组成。
- 首部==前一部分==的长度**固定**，共==20B==，是所有IP分组必须具有的。 #注意
- 在首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检测及安全等机制。
### 详细字段
![](attachments/IPv4%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%9A%84%E6%A0%BC%E5%BC%8F%202022-10-12%2020.41.32.excalidraw.svg)
%%[🖋 Edit in Excalidraw](attachments/IPv4%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%9A%84%E6%A0%BC%E5%BC%8F%202022-10-12%2020.41.32.excalidraw.md)%%
- 1)**版本**。占4位。指IP的版本，目前广泛使用的版本号为4。
- 2)**首部长度**。占4位。
	- 以==4B==为单位 #注意
	- 最大值为60B ($15*4B$)。最常用的首部长度是**20B**,此时不使用任何选项(即可选字段)。
- 3)**总长度**。占16位。 #注意 对比:TCP报文没有总长度字段
	- 指==首部和数据之和的长度==，单位为==B==  #z408 
		- #注意 单位为==B== ,无需是4B的倍数
	- **理论上** 
		- 只有16位,因此IP数据报*的最大长度为2^16-1= ==65535B==。 #注意
	- **实际上**
		- 由于**以太网帧**的最大传送单元(MTU)为==1500B== #注意
		- 因此当一个IP数据报封装成帧时，数据报的总长度(==首部加数据==) 一定不能超过下面数据链路层的**MTU值**。
		- [IP数据报分片-链路层MTU的限制](IP数据报分片-链路层MTU的限制.md)
- 4)**标识**。占16位。
	- 它是一个计数器，每产生一个==数据报==就加1,并赋值给标识字段。
		- #注意 同一个数据报的多个IP分组的标识位==相同==
	- 但它并不是“序号”(因为IP是无连接服务)。当一个数据报的长度超过网络的MTU时，必须**分片**，此时每个数据报片都复制一次标识号， ==以便能正确重装成原来的数据报==。
- 5)**标志**。占3位。
	- 标志字段的最低位为MF, ==MF= 1表示后面还有分片==，MF= 0表示最后一个分片。”  #注意
	- 标志字段中间的一位是DF,只有当==DF =0时才允许分片==。
		- DF:Don't Fragment #注意
		- MF:More Fragment #注意
- 6)**片偏移**。占13位。
	- 它指出较长的分组在==分片后==，某片在**原分组中的相对位置**
	- 片偏移以==8个字节==为偏移单位,8B，即**每个分片**的==数据字段==长度一定是8B (64 位)的==整数倍==。 #注意 #z408 
		- 🐱因此 MTU=800B的链路上,总长度为1580B的IP数据报进行IP分片时,理论上IP分组的数据字段最多是800-20=780B,实际上需要是8的倍数,**数据字段**因此是==776B==,**总长度是**796B
- 7)**首部校验和**。占16位。
	- IP数据报的首部校验和只校验==分组的首部==，而不校验数据部分。 #注意 ^g29e95
		- [UDP校验](UDP校验.md)
	- #注意 IP分组每经过一个跳就会改变头部检验和
- 8)**生存时间**(TTL)。占8位。数据报在网络中可通过的路由器数的最大值，标识分组在网络中的寿命，以确保分组不会永远在网络中循环。
	- 路由器在转发分组前，==先把TTL减1==。 #注意
	- **若TTL被减为0，则该分组必须丢弃**。 #注意 
- 9)**协议**。占8位。指出此分组携带的数据使用何种协议，即分组的数据部分应交给哪个==传输层协议==， ^9qgyhl
	- UDP(==17==)，TCP(==6==)，ICMP(==1==)，GGP(3)，EGP(8)，IGP(9)，**OSPF**(==89==) #注意
	- [[网际控制报文协议ICMP]]
- 10)**源地址字段**。占4B，标识发送方的IP地址。
- 11)**目的地址字段**。占4B，标识接收方的IP地址。

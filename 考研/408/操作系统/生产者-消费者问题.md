# 生产者-消费者问题
## 问题描述
- 有一组生产者进程和一组消费者进程
- 共享一个初始为空、大小为n的缓冲区
- 只有缓冲区**没满**时，生产者才能把产品放入缓冲区，否则必须等待
- 只有缓冲区**不空**时，消费者才能从中取出产品，否则必须等待
- 缓冲区是临界资源，各进程必须**互斥地**访问
![](attachments/Pasted%20image%2020220923215441.png)

## 问题分析
- **互斥关系**
	- 缓冲区的互斥访问 #注意 **通常都是1**
		-  `semaphore mutex = 1;`
		- 只有为1是才能访问 
- **同步关系**
	- 缓冲区满了之后**不能生产**
		- `semaphore empty = n;`
		-  同步信号量，表示**空闲缓冲区**的数量
		- 初始n个空闲,可以生产
	- 缓冲区空了之后**不能读取**
		- `semaphore full = 0;`
		- 同步信号量，表示产品的数量，也即**非空缓冲区的数量**
		- 初始0个产品,不能读取

![](attachments/%E7%BB%8F%E5%85%B8%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98%202022-09-23%2022.04.16.excalidraw.svg)
%%[🖋 Edit in Excalidraw](attachments/%E7%BB%8F%E5%85%B8%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98%202022-09-23%2022.04.16.excalidraw.md)%%

- **为什么不能先判断是否可以访问,而是先判断是否能生产?**
	- 实现互斥的P操作一定要在实现同步的P操作**之后** #注意 #d408 
	- 注意下图和上图的区别
	- ![](attachments/Pasted%20image%2020220923221353.png)
	- 若此时缓冲区内已经放满产品，则 empty=0，full=n。 则生产者进程执行① 使mutex变为0，再执行②，由于已没有空闲缓冲区，因此生产者被阻塞。
	- 由于生产者阻塞，因此切换回消费者进程。消费者进程执行③，由于mutex为0，即**生产者还没释放对临界资源的“锁”，因此消费者也被阻塞**。  #注意 
		- ==即一定要确保能够放进去/取出来,再去获取临界资源使用权(即互斥访问权限)== #注意 
	- 这就造成了生产者等待消费者释放空闲缓冲区，而消费者又等待生产者释放临界区的情况，生 产者和消费者循环等待被对方唤醒，**出现“死锁”**。 同样的，若缓冲区中没有产品，即full=0，empty=n。按③④① 的顺序执行就会发生死锁
- **先设置增加产品数量,再设置能生产会发生什么**?
	- V操作不会导致进程阻塞，因此两个V操作顺序**可以**交换。 #注意 

# 多生产者-多消费者
## 问题描述
![](attachments/%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%202022-09-23%2022.21.19.excalidraw.svg)
%%[🖋 Edit in Excalidraw](attachments/%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%202022-09-23%2022.21.19.excalidraw.md)%%
## 问题分析
### 我的分析
- **互斥关系**
	- `semaphore mutex=1`
- **同步关系**
	- 最多有一个水果,缓冲区剩余空间
		- `semaphore fruit=1`
	- 有橘子才能吃橘子
		- `semaphore org=0`  橘子数量
		- 初始可以生产橘子,不能吃橘子(p(org))
	- 有苹果才能吃苹果
		- `semaphore Apple=0` 苹果数量

爸爸:
生产苹果
p(fruit)
p(mutex)
放苹果
v(apple)
v(mutex)

女儿:
p(apple)
p(mutex)
吃苹果
v(fruit)
v(mutex)

### 实际实现
- 总体与我的设计想法相同
- #注意 以上的"fruit"变量命名为"plate"资源更加合适,即plate=0即没有盘子时,无法生产.
![](attachments/%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%202022-09-25%2018.46.31.excalidraw.svg)
%%[🖋 Edit in Excalidraw](attachments/%E7%94%9F%E4%BA%A7%E8%80%85-%E6%B6%88%E8%B4%B9%E8%80%85%E9%97%AE%E9%A2%98%202022-09-25%2018.46.31.excalidraw.md)%%
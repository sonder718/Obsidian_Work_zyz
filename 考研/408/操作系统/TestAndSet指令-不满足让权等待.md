## TestAndSet指令
- 简称 TS 指令，也有地方称为 TestAndSetLock 指令，或 TSL 指令
- 现代 CPU 体系结构提供的特殊**原子操作指令 —— 测试和置位（_Test-and-Set_）指令**。
- TSL 指令是用**硬件**实现的，执行的过程不允许被中断，只能一气呵成。
-   测试并设置指令做了下述事情:
	-   把 `old_ptr` 更新为 `new` 的新值
	-   返回 `old_ptr` 的旧值；
当然，**关键是这些代码是原子执行**。因为既可以测试旧值，又可以设置新值，所以我们把这条指令叫作「测试并设置」。
- 我们可以运用 Test-and-Set 指令来实现「忙等待锁」，代码如下：
- lock=false 负责唤醒处于**就绪态**的进程 #疑问 #注意 
- while(TestAndSet()) 在**开中断下执行** #注意
	- 如果在关中断下,一直为true,不再开中断,系统将终止
![](attachments/%E5%AE%9E%E7%8E%B0%E4%B8%B4%E7%95%8C%E5%8C%BA%E4%BA%92%E6%96%A5%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%96%B9%E6%B3%95%202022-09-22%2022.06.35.excalidraw.svg)
%%[🖋 Edit in Excalidraw](attachments/%E5%AE%9E%E7%8E%B0%E4%B8%B4%E7%95%8C%E5%8C%BA%E4%BA%92%E6%96%A5%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%96%B9%E6%B3%95%202022-09-22%2022.06.35.excalidraw.md)%%

- 很明显，当获取不到锁时，线程就**会一直 wile 循环**，不做任何事情，所以就被称为「忙等待锁」，也被称为**自旋锁（_spin lock_）**。 #疑问 [图解系统：互斥与同步 - 知乎 (zhihu.com)](https://zhuanlan.zhihu.com/p/161936748)
	- 这是最简单的一种锁，一直自旋，利用 CPU 周期，直到锁可用。在单处理器上，需要**抢占式的调度器**（即不断通过时钟中断一个线程，运行其他线程）。否则，自旋锁在单 CPU 上无法使用，因为一个自旋的线程永远不会放弃 CPU。 
- **无等待锁**顾明思议就是获取不到锁的时候，不用自旋。
	- 既然不想自旋，那当没获取到锁的时候，就把当前线程放入到锁的等待队列，然后执行调 度程序，把 CPU 让给其他线程执行。
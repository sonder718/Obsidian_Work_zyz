# Tips

# 调度程序(调度器)
![](attachments/%E8%B0%83%E5%BA%A6%E7%9A%84%E5%AE%9E%E7%8E%B0%202022-09-22%2015.05.01.excalidraw.svg)
%%[🖋 Edit in Excalidraw](attachments/%E8%B0%83%E5%BA%A6%E7%9A%84%E5%AE%9E%E7%8E%B0%202022-09-22%2015.05.01.excalidraw.md)%%
- 用于**调度和分派**CPU的组件
- ![](attachments/Pasted%20image%2020220926162526.png)
## 结构
- 排队器
	- **就绪进程**按一定策略排成一个或多个队列
	- 就绪一个插一个
- 分派器
	- 从就绪队列取出进程,分派CPU
- 上下文切换器
	- **两对上下文切换操作**
		- 当前进程上下文保存到其PCB,装入**分派程序的上下文**
		- 移出分派程序的上下文,将**新选进程的CPU现场信息**装入**处理机的各个相应寄存器**
	- 执行大量load和store指令,开销大
	- **硬件方式减少开销**(两组寄存器)
		- 一组寄存器供内核使用
		- 一组供用户使用
		- 上下文切换只需改变指针指向当前寄存器组 #疑问
# 调度的时机,切换和过程
## 进程调度与切换的区别
- **狭义的进程调度**
	- 指的是从就绪队列中选中一个要运行的进程。（这个进程可以是刚刚被暂停执行的进程， 也可能是另一个进程，后一种情况就需要进程切换）
- **进程切换**
	- 指一个进程让出处理机，由另一个进程占用处理机的过程。
	- 进程切换的过程主要完成了： 1. 对原来运行进程各种数据的保存 2. 对新的进程各种数据的恢复 （如：程序计数器、程序状态字、各种数据寄存器等处理机现场信息，这些信息一般保存在进程控制块
- **广义的进程调度**
	- 包含了选择一个进程和进程切换两个步骤
## 什么时候不能进程切换
### 三种情况
- **处理中断的过程**
	- 中断处理逻辑上不属于某一进程 #注意 
- **进程在操作系统内核临界区**
	- 独占式访问
	- 加锁
	- ==是内核临界区==,不是简单的==临界区==进程处于临界区时可以进行处理器调度 #注意 
		- 内核临界资源
		- 内核程序临界区一般是用来访问某种内核数据结构的，比如进程的就绪队列（由各就绪进程的PCB组成）
- **需要完全屏蔽中断的原子操作过程**
	- 🐱加锁,解锁,中断现场保护,恢复
### 发生引起调度条件怎么做
置系统的请求调度标志,结束后再调度

## 何时进程调度/切换
调度时机——什么事件会触发“调度程序” ？ 
• 创建新进程 • 进程退出 • 运行进程阻塞 • I/O中断发生（可能唤醒某些阻塞进程）
### 非剥夺调度
- 操作系统**只支持**以下情形进行调度,称为非剥夺调度
	- **发生了调度条件**,且当前进程**无法继续运行**,==马上==进程调度
	- 非抢占式调度策略，只有运行进程阻塞或退出才触发调度程序工作
### 剥夺方式的调度
- **发生时机**
	- 中断处理结束或自陷处理结束**后**
	- 返回被中断的进程的用户态执行现场**前**
		- #注意 因此系统调用完成,返回用户态时可以进行处理机调度
	- 置**请求调度标识** 
		- 抢占式调度策略，每个时钟中断或k个时钟 中断会触发调度程序工作
- 此事**马上进行进程的调度**,即实现了剥夺方式的调度

## 进程调度方式
- 指当某个进程正在执行,某个更重要的进程要处理,即**有优先级更高的进程进入就绪队列**的处理方式
### 非抢占式调度(非剥夺方式)
- 该进程**运行完成**或阻塞才分配
	-  #注意 这里没有时间片轮转,因此不会出现未完成而进入就绪状态
- #注意 不能用于分时系统和大多实时操作系统
### 抢占调度方式(剥夺方式)
- 运行**根据某种原则**暂停进程,并重新分配
- 提高吞吐量和响应效率
## 闲逛进程idle
- 没有就绪进程就**调度闲逛进程运行** #注意
- 不需要CPU之外的资源

## 两种线程的调度
### 用户级线程
- 进程中的调度程序决定
	- 内核不知道线程的存在
### 内核级线程
- 内核选择一个特定线程运行,通常不考虑属于哪个进程
- 切换需要完整的上下文切换,修改内存映像,使高速缓存失效->延迟大



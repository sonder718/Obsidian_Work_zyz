### 数据冲突-数据冒险-写后读
#### 什么是数据相关（数据冲突）
数据相关指在一个程序中，存在必须等前一条指令执行完才能执行后一条指令的情况(**下一条指令会用到当前指令计算出的结果**)，则这**两条指令**即为数据相关。
#注意 数据相关对流水线影响==最严重==
![](attachments/%E6%8C%87%E4%BB%A4%E6%B5%81%E6%B0%B4%E7%BA%BF%202022-09-19%2015.17.17.excalidraw.svg)
%%[🖋 Edit in Excalidraw](attachments/%E6%8C%87%E4%BB%A4%E6%B5%81%E6%B0%B4%E7%BA%BF%202022-09-19%2015.17.17.excalidraw.md)%%
- **写后读(Read After Write,RAW)** 相关
	- 当前指令将数据**写入寄存器后**,下一条指令**才能**从该寄存器**读**取数据,否则是错误的数据
	- 按序流动的流水线==只可能出现==RAW 相关。 #注意
		- **流水线按序**发射**按序**完成是指要求下一条指令的==取指阶段==(Instruction Fetch)和上一条指令的==译码阶段==(Instruction Decoder) **并行**
		- 因此先进入流水线的指令的取操作数和写回结果在**一定**在后进入的指令之前之前
		- 不会出现A取操作数,B已经要写回了
	- 在以下指令对中I2和I3==不存在==数据相关 #z408 
		- ![](attachments/Pasted%20image%2020221201172954.png)
- **读后写(WAR)**  相关
	- 当前读出,下一条才能写
- **写后写(WAW)** 相关
	- 当前写入,下一条才能写
![](attachments/Pasted%20image%2020220919155104.png)
#### 解决方案
- 遇到数据相关的指令机器后续指令**都暂停一至几个时钟周期**,直到数据相关问题消失后再继续执行
	- **硬件阻塞stall**
		- 在硬件上通过阻塞（stall）方式阻止后续指令执行，延迟到有新值以后！
		- 缺点是会使电路变得复杂，延迟比较大。
		- ![](attachments/Pasted%20image%2020221203220251.png)
	- **软件插入"NOP"指令**
		- ![](attachments/Pasted%20image%2020221203220305.png)
- 设置相关专用通路(**数据旁路技术**)
	- 不等Wr阶段写回寄存器而是在硬件上稍加改动直接将流水段寄存器中的数据送往下一指令的ALU输入端，这种操作称为 **转发（Forwarding）或旁路（Bypassing）**
	- 直接把前一条指令的ALU计算结果,作为自己的输入数据开始计算过程,**不再进行前一条写入寄存器组,后一条读出寄存器组**
	- #注意 可以与插入Nop指令技术结合,使得==执行周期==后执行下条冲突指令的**译码**操作
- 通过编译器对数据相关的指令**编译优化**,调整指令顺序来解决数据相关

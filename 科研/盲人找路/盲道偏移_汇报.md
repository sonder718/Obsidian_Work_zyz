盲道偏移的两个核心问题:

# 判断是否踩在盲道上

   初始我们作出如下**假设**:人的脚所处位置即图像底部中心点

   可以**提取底部两个关键点,与图像底部中心点进行对比**,从而得到行人是否在盲道两边界之间,即是否位于盲道上.

   ![image-20220502204537112](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220502204537112.png)

然而判断是否在盲道上的一个核心要素在于相机的最近视野范围离脚的距离,离脚越近,越能够更加精确的判断.但若将相机的角度调整得过大则**无法获取更远的信息**,因此我们将俯角调整为45度,高度位于**1米处**进行测量.此时**人的脚所处位置即图像底部中心点**的假设失效,在盲道偏转角度**较大**时无法正确判定是否踩在盲道上.

   为了解决这个问题,我们将图像坐标系映射到现实,利用**盲道边界线的深度信息、角度信息与图像坐标系中坐标**得到,以盲人为中心的现实坐标系中盲人与两边界的距离情况.具体转换如图所示:
![image-20220502213259038](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220502213259038.png)

以下是两种位置关系情况:

位于盲道上

![image-20220502214318122](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220502214318122.png)

盲人在盲道外,位于右侧

![image-20220502214352205](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220502214352205.png)

由是,我们得以解决第一个问题即判断是否踩在盲道上

# 判断当前行走方向

## 连续点偏移判断

由于行人的朝向并不能代表其行走方向,其行走方向的判断需要依托连续视频帧,一种较为有效的方式是利用连续帧中的盲人与盲道两边界的距离变化进行.

其算法原理是利用一个全局列表记忆**最近连续三帧**的画面**盲道偏移情况**，连续三帧画面都偏向**同一边界**（边界为盲道的左右边界线）则判断此时盲人**正在向某方向偏离盲道**；如果连续三帧中不完全偏向同一边界，则说明此时盲人在盲道中央。

盲道偏移情况的公式如下:
$$
departure=max(\vert{left-pcenter}\vert,\vert{right-pcenter}\vert)
$$

$$
dwhere=\begin{cases}
0 & left-pcenter>0 \\
1 & right-pcenter>0 
\end{cases}
$$

在列表中存满三帧后,删除列表中最早加入的元素可以保证每一帧画面（从第三帧开始）都可以利用到前面连续三帧盲道的偏离信息。

当连续偏移三帧后即会提示偏移方向

![image-20220502220245164](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220502220245164.png)

当不断偏移出盲道后,即提示盲人盲道所处的相当方位,以引导其走回盲道

![image-20220502220257838](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220502220257838.png)



## 光流法

另一种思路是利用光流判断当前行走方向并与盲道走向进行对比判断.

### 准备工作

考虑到算法的实时性,相较于稠密光流,稀疏光流能够更加满足实时性的需求,我们采用Lucas-Kanade算法进行计算稀疏特征集的光流.

为了方便统计光流向量,我们生成HOF光流直方图进行可视化特征.即计算光流向量与横轴的夹角,计算的夹角结果分配到各自的区间（这里面每**30度**定义一个区间）,即如下图所示,将0-30度作为0类,30-60度作为1类向量,自从得到12类特征向量.

考虑到在盲道行走场景中,图像是运动的,图像中的像素点的向后移动(我们将本分类向量中即**2类与3类向量**近似看作像素点向后移动)即代表着相机(盲人)的向前移动.

![image-20220502221602024](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220502221602024.png)

得到类如下图的光流直方图

![83](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/83.jpg)

### 分类印证

为了推断出更多规律,我们选取如下场景进行测试:

1. 完全直线行走场景
2. 转弯场景



此外为了寻找能够更好描述场景运动的特征点,我们采用如下特征点选取策略进行测试:

1. 角点检测选取最多100个强角点

2. 遮挡除盲道外的区域,角点检测选取最多100个强角点

3. 盲道正中心的+-200像素,间隔20

4. 盲道区域内随机选取100个特征点

5. ``1920*1280``分割成16个``480*320``的小块,考虑到行走过程中像素点的移动可能会偏离图像区域,只选取中间9个的区域进行光流判断

6. ``1920*1280``分割成128个``120*160``的小块,选取中心进行判定

   

此外还有一些潜在的想法如下:

1. 转为鸟瞰图,即考虑到图片中物体的移动方向与实际的移动方向有较大差距,即近处移动明显,远处移动不明显
2. 去除横向或纵向移动太大的光流向量,其更可能错误



### 完全直线行走场景

完全直线行走场景是一种典型场景,我们就不同特征点选取策略进行对比

#### 角点检测选取最多100个强角点

![](attachments/frame.png)

#### 遮挡除盲道外的区域,角点检测选取最多100个强角点
![](attachments/frame%201.png)

#### 盲道正中心的+-100像素,间隔20

![](attachments/frame%202.png)

#### 盲道分为3块,3块中心的+-50像素,间隔20

![](attachments/frame%203.png)

#### 取盲道区域``10*25``

平均用时0.05s
![](attachments/frame%207.png)

#### 取盲道区域``20*50``

平均用时0.1s
![](attachments/frame%208.png)

#### 全局分块为``20*50``

去除较远处点与边界处点
平均用时约0.1s
![](attachments/frame%205.png)

#### 全局分块为``20*100``块

平均用时0.26S
![](attachments/frame%206.png)

### 总结特征选取

通过以上完全直线行走场景的对比,由于是直线行走,我们假定分类为2,3类特征向量为最多或次多为项判断正确,则正确率表格如下

| 选取策略                                       | 正确率 | 用时(s) |
| ---------------------------------------------- | ------ | ------- |
| 角点检测选取最多100个强角点                    | 0.33   | 0.02    |
| 遮挡除盲道外的区域,角点检测选取最多100个强角点 | 0      | 0.02    |
| 盲道正中心的+-100像素,间隔20                   | 0.33   | 0.04    |
| 盲道分为3块,3块中心的+-50像素,间隔20           | 0.66   | 0.04    |
| 取盲道区域``10*25``                            | 0.66   | 0.05    |
| 取盲道区域``20*50``                            | 1      | 0.1     |
| 全局分块为``20*50``                            | 0.66   | 0.1     |
| 全局分块为``20*100``块                         | 0.33   | 0.26    |

考虑到本系统所要求的实时性,我们希望光流判断用时要少于0.15s,另外考虑到摄像机拍摄距离有限,盲道具有更高的辨识度,同时不易受移动物体的影响,我们对**取盲道区域特征点**的策略进行进一步研究.

### 取盲道区域

平均用时0.05,后三帧预测较差

![frame](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/frame.png)

**进一步细化**为``40*50``进行取样后效果良好,平均速度0.15亦可接收

![image-20220503003327125](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220503003327125.png)

#### 将选取区域进一步靠近使用者

随着选取区域一再靠近使用者,直行的特征更加突出,平均用时0.1s,运行效率良好

![image-20220503003846631](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220503003846631.png)

![image-20220503004150625](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220503004150625.png)



## 向左偏移

我们假设正常情况下盲人不会倒退行走,因此对于像素点向前偏移的矢量,我们更加关注其水平分量.

因此类别为0,1,10,11,12的特征向量代表像素点向左偏移,即人向右偏移,以下是进行偏移时的特征向量.

![image-20220503010606209](%E7%9B%B2%E9%81%93%E5%81%8F%E7%A7%BB_%E6%B1%87%E6%8A%A5.assets/image-20220503010606209.png)